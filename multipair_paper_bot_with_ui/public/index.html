<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wunder Paper Trader â€” Dashboard</title>
<style>
:root{--bg:#0b0f14;--card:#111826;--muted:#9fb3c8;--line:#1f2836;--good:#7ce38b;--bad:#ff8a8a}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e6edf3;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:1100px;margin:24px auto;padding:0 16px}
.h1{font-size:22px;margin:0 0 16px;display:flex;align-items:center;gap:10px}
.badge{background:#233046;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.btn{background:#20314a;border:1px solid #2d3e5b;color:#e6edf3;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.alt{background:#1b2538}
.btn.good{background:#15351f;border-color:#1b4f2b}
.btn.bad{background:#402127;border-color:#6c2a32}
.small{font-size:12px;color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{color:var(--muted);font-weight:600}
.right{text-align:right}
.up{color:var(--good)} .down{color:var(--bad)}
.kv{display:flex;gap:18px;flex-wrap:wrap}
.kv div{background:#0c131d;border:1px solid var(--line);padding:8px 12px;border-radius:10px}
.slider{width:180px}
</style>
</head>
<body>
  <div class="container">
    <div class="h1">ðŸ“Š Wunder Paper Trader <span class="badge" id="badge">paper mode</span></div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <button class="btn" id="refresh">Refresh</button>
          <button class="btn alt" id="pause">Pause</button>
          <div class="small" id="updated">â€”</div>
        </div>
        <div class="kv" style="margin-top:10px">
          <div>Total Realized PnL: <b id="rpnl">0</b></div>
          <div>Equity (R+U): <b id="equity">0</b></div>
          <div>Polling: <b id="poll">2s</b></div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;gap:8px">
          <div><b>Send Manual Signal</b> <span class="small">(quote notional via strength Ã— base qty)</span></div>
          <div class="row">
            <label class="small">Strength: <span id="strengthVal">1.0</span></label>
            <input type="range" min="0.1" max="2" step="0.1" value="1" class="slider" id="strength">
          </div>
        </div>
        <div id="signalBtns" class="row" style="margin-top:10px"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px">Prices & Positions</h3>
        <table id="pp"><thead><tr><th>Symbol</th><th class="right">Price</th><th class="right">Qty</th><th class="right">Avg Entry</th><th class="right">UPnL</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

<script>
let state = null;
let timer = null;
const REFRESH_MS = 2000;

const $ = sel => document.querySelector(sel);
const tbody = $("#pp tbody");
const btnRefresh = $("#refresh");
const btnPause = $("#pause");
const strength = $("#strength");
const strengthVal = $("#strengthVal");
const signalBtns = $("#signalBtns");

function dollars(n){ n=Number(n||0); return (n>=0?'+':'') + n.toFixed(2) }
function fmt(n,d=6){ n=Number(n||0); return n.toFixed(d) }

async function fetchState(){
  const r = await fetch('/api/state', {cache:'no-store'});
  if(!r.ok) throw new Error('state fetch failed');
  return r.json();
}
async function sendPause(paused){
  const r = await fetch('/api/pause',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paused})});
  return r.json();
}
async function sendSignal(symbol, side){
  const s = Number(strength.value);
  const r = await fetch('/api/signal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({symbol, side, strength:s})});
  return r.json();
}

function render(){
  if(!state) return;
  $("#updated").textContent = new Date((state.time||0)*1000).toLocaleString();
  $("#rpnl").textContent = dollars(state.realized_pnl);
  $("#badge").textContent = state.paused ? "PAUSED" : "paper mode";
  $("#poll").textContent = "2s";
  let eq = state.realized_pnl;
  tbody.innerHTML='';
  (state.symbols||[]).forEach(s=>{
    const px = state.prices[s] || 0;
    const pos = (state.positions||{})[s] || {qty:0,avg_entry:0};
    const u = (pos.qty>0)? (px - (pos.avg_entry||0))*pos.qty : 0;
    eq += u;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${s}</b></td>
      <td class="right">${fmt(px)}</td>
      <td class="right">${fmt(pos.qty)}</td>
      <td class="right">${fmt(pos.avg_entry)}</td>
      <td class="right ${u>=0?'up':'down'}">${dollars(u)}</td>`;
    tbody.appendChild(tr);
  });
  $("#equity").textContent = dollars(eq);
  // signal buttons
  signalBtns.innerHTML='';
  (state.symbols||[]).forEach(s=>{
    const wrap = document.createElement('div'); wrap.className='row';
    const bBuy = document.createElement('button'); bBuy.className='btn good'; bBuy.textContent=`BUY ${s}`;
    const bSell= document.createElement('button'); bSell.className='btn bad';  bSell.textContent=`SELL ${s}`;
    bBuy.onclick = async ()=>{ bBuy.disabled = bSell.disabled = true; await sendSignal(s,'buy').catch(()=>{}); bBuy.disabled=bSell.disabled=false; };
    bSell.onclick= async ()=>{ bBuy.disabled = bSell.disabled = true; await sendSignal(s,'sell').catch(()=>{}); bBuy.disabled=bSell.disabled=false; };
    wrap.appendChild(bBuy); wrap.appendChild(bSell);
    signalBtns.appendChild(wrap);
  });
}

async function tick(){
  try{
    state = await fetchState();
    render();
  }catch(e){
    console.error(e);
  }
}

btnRefresh.onclick = tick;
btnPause.onclick = async ()=>{
  const target = !(state&&state.paused);
  const res = await sendPause(target).catch(()=>({}));
  await tick();
};

strength.oninput = ()=> strengthVal.textContent = Number(strength.value).toFixed(1);

tick();
timer = setInterval(tick, REFRESH_MS);
</script>
</body>
</html>